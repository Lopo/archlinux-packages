# Contributor: Jonas Heinrich <onny@project-insanity.org>
# Contributor: Massimiliano Torromeo <massimiliano.torromeo@gmail.com>
# Maintainer: Pavol (Lopo) Hluchy <lopo AT losys DOT eu>

pkgname=gitlab
pkgver=7.4.1
pkgrel=1
pkgdesc="Project management and code hosting application"
arch=('i686' 'x86_64')
url="http://gitlab.org/gitlab-ce"
license=('MIT')
depends=('ruby>=2.0' 'git>=1.7.10' 'ruby-bundler>=1.5.2' 'gitlab-shell>=2.0.1' 'openssh' 'redis>=2.0' 'libxslt' 'icu')
makedepends=('cmake')
optdepends=(
	'mariadb: database backend'
	'postgresql>=9.1: database backend'
	'python2-docutils: reStructuredText markup language support'
	'postfix: mail server in order to receive mail notifications'
	)
backup=(
	etc/webapps/gitlab/application.rb
	etc/webapps/gitlab/gitlab.yml
	etc/webapps/gitlab/database.yml
	etc/webapps/gitlab/unicorn.rb
	etc/logrotate.d/gitlab)
#source=("$pkgname-$pkgver.tar.gz::https://gitlab.com/gitlab-org/gitlab-ce/repository/archive.tar.gz?ref=v${pkgver}"
source=("$pkgname-$pkgver.tar.gz::https://github.com/gitlabhq/gitlabhq/archive/v${pkgver}.tar.gz"
	gitlab.target
	gitlab-unicorn.service
	gitlab-sidekiq.service
	gitlab.tmpfiles.d
	gitlab.logrotate
	gitlab-apache2.4.conf
	gitlab-ssl-apache2.4.conf
	gitlab.conf
	gitlab-ssl.conf
	gitlab-ssl
	10-gitlab.conf)
install='gitlab.install'
sha512sums=('278ea0998645eb5a71999f4d3b5531e925744cf9cc1bfb3769e0e2f05ef18f08e56050a1313c50951adb55d430fa6717a50b0e5345d13b2cb4ae9e54563a6e5e'
	'c88b7b500225c9a2bfaf10912fc09e5a3beb7c28890dcc1d49d55dfe92df02cef3f1865a138e7e2802b4e795c9a45cb130819be0a1c115eca9b566b8b9fb4395'
	'b6724b4171a1a62dee10bea6c9e1fd20eb6788ba61622c58ced80bef9cf7401b7c6a17a5a5a38ad677a0b224b09ff2b0be3737d89e5718b4f1391a57d91148e9'
	'df653dbe2f47bf8f4adaaa274574cc94c1e66055415b58ba31e753e23805a9e3e4fce984076c76c9ccf86887c77a3af80a8a006744b2409dda31f3671f7e39d2'
	'b98ba6cbd8745a649046386f4aad6ee3d869b8e14820560e25b3207683dcd0841e1af8afb5537e6e06bf19d9436489420db59348c57f4c096c69b0ea4f2e7978'
	'8b0094a4f7bffb909a0ded0d86fbe93c96dd684902354e191844361e36a61109c4696b2003734d57d2d4fe65ba4ebafb87d211c1a9ee532cdc87a1a8abeec0f6'
	'cd6b9cae3206dbaa3cd893ea0ead43ffbc70eb6a2ad4bacd3abab1150c751aa4ea64c9931409ac97ee36a2ae83fc019c8eb82b2fe11d5f5b4803a81fa5e79152'
	'02ac0aed9cc2262e267b1aab025245659d9b8f6e4ea1bfa9941e8ccd5fcd31ea8a20fd18968a949fc1faded37c58ebb3e39bf548b66a2cbdb51b86b536a1596a'
	'f021ddcaaf8f4e92db7684f3a7eb34d4d00911efe5a3d57bc78ebb0b9636b2639b1990047c8da3f6d7339ad7a89574cfbfeb59a79c30b099e6f44ecfbf3166f7'
	'8176d01b7dc627007134d451e8c38bdf2794fcd02af0468dacde39255b3b17a8a7d3530f8a12d25bd20723f7bd657cca518b27d1c2f0373974f44428fc51a0b4'
	'37914ba29d7d10a5f863c0c8d89f33936888a747fe1bb55bc89b912bdf84def9f5e3d21703ccd1aef195e2f317ae35cefd3b28d0473310234d0a12055403b6dd'
	'c78b6f46abcf603d8db6e38cf50868e14145928422ddfe17c88e2f006b5b910dddf456ec5d6d724b250994530643963809688a98f7e12ebd5b5dabf7f96f0e06')
_server=()
if [[ `pacman -T apache` == '' ]]; then
	warning "detected apache"
	if [[ `pacman -T 'apache>=2.4'` == '' ]]; then
		msg2 ">=2.4"
	fi
	backup+=('etc/httpd/conf/extra/gitlab.conf'
		'etc/httpd/conf/extra/gitlab-ssl.conf')
	_server+=('apache')
fi
if [[ `pacman -T nginx` == '' ]]; then
	warning "detected nginx"
	backup+=('etc/nginx/sites-available/gitlab-ssl')
	_server+=('nginx')
fi
if [[ `pacman -T lighttpd` == '' ]]; then
	warning "detected lighttpd"
	backup+=('etc/lighttpd/conf.d/10-gitlab.conf')
	_server+=('lighttpd')
fi

_homedir='/var/lib/gitlab'
_datadir='/usr/share/webapps/gitlab'
_srcdir="gitlabhq-${pkgver}"
_wo=()
if [[ `pacman -T libmariadbclient` != '' ]]; then
	_wo+=('mysql')
else
    warning "detected libmariadbclient"
fi
if [[ `pacman -T postgresql-libs` != '' ]]; then
	_wo+=('postgres')
else
    warning "detected postgresql-libs"
fi

prepare() {
	if [[ ${#_wo[@]} == 2 ]]; then
		error "Usable DB libs not found"
		msg2 "Install at least libmariadbclient or postgresql-libs"
		return 1
	fi

	cd "${srcdir}/${_srcdir}"

	# Patching config files:
	sed -e "s|# user: git|user: gitlab|" \
		-e "s|/home/git/repositories|${_homedir}/repositories|" \
		-e "s|/home/git/gitlab-satellites|${_homedir}/satellites|" \
		-e "s|/home/git/gitlab-shell|/usr/share/webapps/gitlab-shell|" \
		config/gitlab.yml.example > config/gitlab.yml
	sed -e "s|/home/git/gitlab/tmp/.*/|/var/run/gitlab/|g" \
		-e "s|/home/git/gitlab|${_datadir}|g" \
		-e "s|timeout 30|timeout 300|" \
		config/unicorn.rb.example > config/unicorn.rb
	sed -e "s|username: git|username: gitlab|" \
		config/database.yml.mysql > config/database.yml
}

build() {
	cd "${srcdir}/${_srcdir}"

	msg "Fetching bundled gems..."
	# Gems will be installed into vendor/bundle

	bundle config build.nokogiri --use-system-libraries
	pline=`grep processor /proc/cpuinfo | tail -n1`
	jobs=${pline##* }
	if [[ $jobs -ge 2 ]]; then
		bundle install -j$jobs --no-cache --no-prune --deployment --without development test aws ${_wo[@]}
	else
		bundle install --no-cache --no-prune --deployment --without development test aws ${_wo[@]}
	fi
}

package() {
	cd "${srcdir}/${_srcdir}"
	install -d "${pkgdir}/usr/share/webapps"
	cp -r "${srcdir}/${_srcdir}" "${pkgdir}${_datadir}"

	# Creating directories
	install -d \
		"${pkgdir}/etc/webapps/gitlab" \
		"${pkgdir}/usr/share/doc/${pkgname}" \
		"${pkgdir}${_homedir}/www" \
		"${pkgdir}${_datadir}/www" \
		"${pkgdir}${_datadir}/public/uploads"
	ln -fs /run/gitlab "${pkgdir}${_homedir}/pids"
	ln -fs /run/gitlab "${pkgdir}${_homedir}/sockets"
	ln -fs /usr/share/webapps/gitlab/log "${pkgdir}${_homedir}/log"

	# Install config files
	for _file in application.rb gitlab.yml unicorn.rb database.yml; do
		mv "config/${_file}" "${pkgdir}/etc/webapps/gitlab/"
		[[ -f "${pkgdir}${_datadir}/config/${_file}" ]] && rm "${pkgdir}${_datadir}/config/${_file}"
		ln -fs "/etc/webapps/gitlab/${_file}" "${pkgdir}${_datadir}/config/"
	done

	# Install license and help files
	mv README.md MAINTENANCE.md CONTRIBUTING.md CHANGELOG config/*.{example,mysql,postgresql} "${pkgdir}/usr/share/doc/${pkgname}"
	install -D "LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
	rm "${pkgdir}/usr/share/webapps/gitlab/LICENSE"

	# Install systemd service files
	for _file in gitlab.target gitlab-unicorn.service gitlab-sidekiq.service; do
		install -Dm0644 "${srcdir}/${_file}" "${pkgdir}/usr/lib/systemd/system/${_file}"
	done

	install -Dm644 "${srcdir}/gitlab.tmpfiles.d" "${pkgdir}/usr/lib/tmpfiles.d/gitlab.conf"
	install -Dm644 "${srcdir}/gitlab.logrotate" "${pkgdir}/etc/logrotate.d/gitlab"

	# Install apache, nginx and lighttpd template files (if they are installed)
	for __server in ${_server[@]}; do
		case ${__server} in
			apache)
				if [[ `pacman -T 'apache>=2.4'` == '' ]]; then
					install -Dm644 "${srcdir}/gitlab-apache2.4.conf" "${pkgdir}/etc/httpd/conf/extra/gitlab.conf"
					install -m644 "${srcdir}/gitlab-ssl-apache2.4.conf" "${pkgdir}/etc/httpd/conf/extra/gitlab-ssl.conf"
				else
					install -Dm644 "${srcdir}/gitlab.conf" "${pkgdir}/etc/httpd/conf/extra/gitlab.conf"
					install -m644 "${srcdir}/gitlab-ssl.conf" "${pkgdir}/etc/httpd/conf/extra/"
				fi
				;;
			nginx)
				install -Dm644 "${srcdir}/gitlab-ssl" "${pkgdir}/etc/nginx/sites-available/gitlab-ssl"
				;;
			lighttpd)
				install -Dm644 "${srcdir}/10-gitlab.conf" "${pkgdir}/etc/lighttpd/conf.d/10-gitlab.conf"
				;;
		esac
	done
}

# vim:set ts=4 sw=4 et:
